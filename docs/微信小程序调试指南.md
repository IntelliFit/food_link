# 微信小程序调试指南

## 📱 基本调试流程

### 1. 启动后端服务

```bash
cd backend
uvicorn main:app --reload --host 0.0.0.0 --port 8888
```

**验证后端是否运行：**
- 访问 `http://localhost:8888/docs` 查看 API 文档
- 访问 `http://localhost:8888/health` 检查健康状态

### 2. 启动前端构建

```bash
# 在项目根目录
npm run dev:weapp
```

**构建成功的标志：**
- 终端显示 "编译成功" 或 "Build completed"
- `dist` 目录下有 `app.json`、`app.js` 等文件

### 3. 在微信开发者工具中打开项目

1. **打开微信开发者工具**
2. **导入项目**：
   - 点击"导入项目"或"+"号
   - **项目目录**：选择项目根目录（`food_link`）
   - **AppID**：使用你的小程序 AppID 或选择"测试号"
   - **项目名称**：food_link

3. **重要设置**（开发阶段）：
   - 点击右上角"详情"
   - 在"本地设置"中：
     - ✅ **勾选"不校验合法域名"**（开发时必须）
     - ✅ **勾选"不校验 TLS 版本"**
     - ✅ **勾选"不校验 HTTPS 证书"**

### 4. 查看调试信息

#### 构建日志（"构建"标签页）
- ✅ **绿色文字**：成功信息
- ❌ **红色文字**：错误信息
- 正常应该看到：
  ```
  Loading project all files...
  Loading project all files success
  编译 app.json
  编译 ext.json
  编译 X 个页面json文件
  ```

#### 控制台（"调试器" → "Console"标签页）
- **警告（黄色）**：通常可以忽略，如基础库版本提示
- **错误（红色）**：需要关注
  - `[object Object]`：通常是 API 调用失败或错误对象未正确序列化
  - 网络错误：检查后端是否启动、API 地址是否正确

#### 网络请求（"调试器" → "Network"标签页）
- 查看所有 API 请求
- 检查请求状态码：
  - `200`：成功
  - `404`：接口不存在
  - `500`：服务器错误
  - `0` 或 `fail`：网络连接失败

## 🔍 常见问题排查

### 问题 1：`[object Object]` 错误

**原因：**
- API 调用失败，错误对象被直接打印
- 某个页面初始化时出错

**排查步骤：**

1. **检查 API 地址配置**
   ```typescript
   // 查看 src/utils/api.ts 第 6-7 行
   const API_BASE_URL = process.env.TARO_APP_API_BASE_URL || 'https://healthymax.cn'
   ```
   
   **如果是本地开发，需要配置环境变量：**
   - 创建 `.env.development` 文件（项目根目录）
   ```env
   TARO_APP_API_BASE_URL=http://localhost:8888
   ```
   - 或者直接修改 `src/utils/api.ts`：
   ```typescript
   const API_BASE_URL = 'http://localhost:8888'  // 开发环境
   ```

2. **查看 Network 标签页**
   - 打开"调试器" → "Network"
   - 刷新页面，查看失败的请求
   - 点击失败的请求，查看详情：
     - Request URL：是否正确
     - Status Code：错误码
     - Response：错误信息

3. **查看 Sources 标签页**
   - 打开"调试器" → "Sources"
   - 找到报错的文件
   - 设置断点，逐步调试

4. **检查后端日志**
   - 查看后端终端输出
   - 确认请求是否到达后端
   - 查看后端错误信息

### 问题 2：模拟器显示空白或错误

**可能原因：**
1. 后端未启动
2. API 地址配置错误
3. 网络请求被拦截

**解决步骤：**
1. ✅ 确认后端服务运行在 `http://localhost:8888`
2. ✅ 确认前端 API 地址指向 `http://localhost:8888`
3. ✅ 在微信开发者工具中勾选"不校验合法域名"
4. ✅ 检查"Network"标签页，查看请求是否发出

### 问题 3：代码包大小超限

**症状：**
- 构建日志显示"代码包大小超过"
- 上传时失败

**解决方案：**
1. **启用代码压缩**（已配置）：
   - `project.config.json` 中 `"minified": true`
   - `"uploadWithSourceMap": false`

2. **清理构建文件**：
   ```bash
   rm -rf dist
   npm run dev:weapp
   ```

3. **检查大文件**：
   - 查看 `dist` 目录下是否有大文件
   - 检查图片资源是否过大

### 问题 4：页面无法跳转

**检查：**
1. `app.config.ts` 中页面路径是否正确
2. 页面文件是否存在（`src/pages/xxx/index.tsx`）
3. 路由参数是否正确

## 🛠️ 调试技巧

### 1. 使用 console.log 调试

```typescript
// 打印对象时，使用 JSON.stringify
console.log('数据:', JSON.stringify(data, null, 2))

// 打印错误时，提取错误信息
catch (error: any) {
  console.error('错误:', error.message || error.errMsg || error)
  console.error('错误详情:', JSON.stringify(error, null, 2))
}
```

### 2. 使用断点调试

1. 在"调试器" → "Sources"中找到代码文件
2. 点击行号设置断点
3. 刷新页面，程序会在断点处暂停
4. 查看变量值、调用栈等

### 3. 查看页面数据

- **调试器** → **AppData**：查看页面数据
- **调试器** → **Wxml**：查看页面结构

### 4. 模拟不同场景

- **网络慢**：在"Network"标签页中设置"Slow 3G"
- **不同设备**：点击模拟器上方的设备选择
- **不同基础库版本**：详情 → 本地设置 → 基础库版本

## 📋 调试检查清单

启动调试前，确认：

- [ ] 后端服务已启动（`http://localhost:8888`）
- [ ] 前端构建成功（`npm run dev:weapp`）
- [ ] 微信开发者工具中已导入项目
- [ ] 已勾选"不校验合法域名"
- [ ] API 地址配置正确（开发环境指向 `localhost:8888`）
- [ ] 构建日志无错误（"构建"标签页）
- [ ] 控制台无严重错误（"调试器" → "Console"）

## 🚨 紧急问题处理

### 如果完全无法启动：

1. **完全清理重建**：
   ```bash
   # 删除构建文件
   rm -rf dist
   # 删除 node_modules（可选）
   rm -rf node_modules
   npm install
   # 重新构建
   npm run dev:weapp
   ```

2. **在微信开发者工具中**：
   - 点击"编译" → "清缓存" → "重新编译"
   - 或者关闭项目，重新导入

3. **检查后端**：
   ```bash
   # 确认后端运行
   curl http://localhost:8888/health
   # 或访问浏览器
   http://localhost:8888/docs
   ```

## 📞 获取帮助

如果问题仍未解决，请提供以下信息：

1. **构建日志**（"构建"标签页的完整输出）
2. **控制台错误**（"调试器" → "Console"中的错误信息）
3. **网络请求**（"调试器" → "Network"中失败的请求详情）
4. **后端日志**（后端终端的输出）
5. **操作步骤**（你做了什么操作后出现的问题）

---

**最后更新：** 2026-02-07

