# 微信小程序登录配置说明

## 🔴 错误信息

如果你看到以下错误：
```
微信登录失败: invalid appsecret, rid: xxx (错误码: 40125)
```

这表示后端的 **AppSecret (SECRET)** 配置不正确。

## 📋 解决步骤

### 1. 检查后端 `.env` 文件

在 `backend` 目录下，检查是否存在 `.env` 文件：

```bash
cd backend
# Windows PowerShell
Test-Path .env
# 或直接查看
dir .env
```

### 2. 创建或编辑 `.env` 文件

如果文件不存在，创建它；如果存在，检查配置是否正确。

**文件位置：** `backend/.env`

**必需配置：**
```env
# 微信小程序配置（必需）
APPID=你的小程序AppID
SECRET=你的小程序AppSecret

# DashScope API 配置（必需）
DASHSCOPE_API_KEY=你的DashScope_API_Key

# Supabase 配置（必需）
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=你的service_role_key

# JWT 配置（必需）
JWT_SECRET_KEY=你的JWT密钥（至少32字符）
```

### 3. 获取微信小程序 AppID 和 AppSecret

#### 步骤 1：登录微信公众平台
1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 使用你的微信扫码登录

#### 步骤 2：找到 AppID
1. 登录后，在左侧菜单找到 **"开发"** → **"开发管理"**
2. 点击 **"开发设置"**
3. 在 **"开发者ID(AppID)"** 部分，可以看到你的 **AppID**
   - 格式类似：`wx1234567890abcdef`
   - 复制这个 AppID

#### 步骤 3：获取或重置 AppSecret
1. 在同一个页面，找到 **"开发者密钥(AppSecret)"** 部分
2. 如果显示 **"已设置"**：
   - 点击 **"重置"** 按钮
   - ⚠️ **重要**：AppSecret 只显示一次，请立即复制保存
3. 如果显示 **"未设置"**：
   - 点击 **"生成"** 按钮
   - ⚠️ **重要**：AppSecret 只显示一次，请立即复制保存

#### 步骤 4：配置到后端
将获取到的 AppID 和 AppSecret 填入 `backend/.env` 文件：

```env
APPID=wx1234567890abcdef
SECRET=abcdef1234567890abcdef1234567890
```

⚠️ **注意事项：**
- AppSecret 只显示一次，如果丢失需要重新生成
- AppSecret 不要泄露给他人
- 不要将 `.env` 文件提交到 Git（已在 .gitignore 中）

### 4. 重启后端服务

配置完成后，**必须重启后端服务**才能生效：

```bash
# 停止当前后端服务（Ctrl+C）
# 然后重新启动
cd backend
uvicorn main:app --reload --host 0.0.0.0 --port 8888
```

### 5. 验证配置

重启后，尝试在小程序中登录。如果还有错误，检查：

1. **AppID 是否正确**
   - 确认 `.env` 中的 `APPID` 与微信公众平台中的一致
   - 确认没有多余的空格或换行

2. **AppSecret 是否正确**
   - 确认 `.env` 中的 `SECRET` 与微信公众平台中显示的完全一致
   - 确认没有多余的空格或换行
   - 如果 AppSecret 已重置，确保使用的是最新的

3. **后端日志**
   - 查看后端终端输出
   - 如果看到 "缺少 APPID 或 SECRET 环境变量"，说明 `.env` 文件未正确加载

## 🔍 常见问题

### Q1: 我忘记了 AppSecret，怎么办？

**A:** 在微信公众平台 → 开发 → 开发设置 → 开发者密钥中，点击"重置"生成新的 AppSecret，然后更新 `backend/.env` 文件。

### Q2: 我使用的是测试号，怎么办？

**A:** 测试号也可以正常使用，AppID 和 AppSecret 在测试号管理页面可以找到。

### Q3: 配置正确但还是报错？

**A:** 检查以下几点：
1. 确认 `.env` 文件在 `backend` 目录下（不是项目根目录）
2. 确认 `.env` 文件格式正确（每行一个配置，没有多余的空格）
3. 确认已重启后端服务
4. 查看后端日志，确认环境变量是否被正确读取

### Q4: 如何确认环境变量已加载？

**A:** 在后端代码中添加临时打印（仅用于调试）：
```python
print(f"APPID: {os.getenv('APPID')}")
print(f"SECRET: {os.getenv('SECRET')[:10]}...")  # 只打印前10个字符
```

## 📝 配置示例

完整的 `backend/.env` 文件示例：

```env
# ============================================
# 微信小程序配置
# ============================================
APPID=wxbb1ce739d73a66e4
SECRET=your_app_secret_here_at_least_32_chars

# ============================================
# DashScope API 配置
# ============================================
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxx

# ============================================
# Supabase 配置
# ============================================
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# ============================================
# JWT 配置
# ============================================
JWT_SECRET_KEY=your-random-secret-key-at-least-32-chars
```

---

**最后更新：** 2026-02-07

