# 食物分析测试后台开发需求

## 📋 项目概述

开发一个食物分析测试后台系统，用于评估和对比千问模型（Qwen）和 Gemini 模型在食物重量估算方面的准确性。系统需要支持批量测试和单张图片测试两种模式，并提供可视化的对比分析界面。

**核心目标：** 计算模型估算重量与真实重量的偏差百分比，并可视化展示两种模型的对比结果。

---

## 🎯 功能需求

### 1. 批量测试功能（ZIP 文件上传）

#### 1.1 输入格式
- **文件类型：** ZIP 压缩包
- **ZIP 内容：**
  - 多张食物图片（支持常见图片格式：jpg, jpeg, png）
  - 一个 `labels.txt` 文本文件（必须）

#### 1.2 标签文件格式（labels.txt）
```
apple.jpg 50g
banana.jpg 120g
rice.jpg 200g
```
- 每行格式：`图片文件名 重量值g`
- 文件名必须与 ZIP 包中的图片文件名完全匹配（包括扩展名）
- 重量单位统一为克（g），数字部分为浮点数或整数

#### 1.3 处理流程
1. 接收 ZIP 文件上传
2. 解压 ZIP 文件，提取所有图片和 `labels.txt`
3. 解析 `labels.txt`，建立图片文件名到真实重量的映射关系
4. 对每张图片：
   - 调用千问模型（Qwen）进行分析
   - 调用 Gemini 模型进行分析
   - 提取两个模型返回的 `estimatedWeightGrams`（估算重量）
   - 计算偏差百分比：`偏差% = |估算重量 - 真实重量| / 真实重量 * 100`
5. 将所有结果汇总，准备展示数据

#### 1.4 输出要求
- 返回包含所有图片分析结果的数组
- 每条记录包含：
  - 图片文件名
  - 真实重量（g）
  - 千问模型估算重量（g）
  - 千问模型偏差百分比（%）
  - Gemini 模型估算重量（g）
  - Gemini 模型偏差百分比（%）
  - 两个模型的其他分析信息（食物名称、营养成分等）

---

### 2. 单张图片测试功能

#### 2.1 输入
- 单张食物图片文件
- 真实重量值（用户手动输入，单位：克）

#### 2.2 处理流程
1. 接收图片和真实重量
2. 同时调用千问模型和 Gemini 模型进行分析
3. 计算两个模型的偏差百分比
4. 返回分析结果和偏差值

#### 2.3 输出要求
- 返回两个模型的完整分析结果
- 包含偏差百分比计算
- 格式与批量测试的单条记录一致

---

### 3. 数据展示要求

#### 3.1 表格展示
- **主要列：**
  - 图片文件名（或缩略图）
  - 真实重量（g）
  - 千问模型估算重量（g）
  - 千问模型偏差（%）
  - Gemini 模型估算重量（g）
  - Gemini 模型偏差（%）
  - 其他分析信息（可展开查看详情）

#### 3.2 对比展示
- 两种模型的结果必须同时展示，方便对比
- 偏差百分比建议用颜色标识：
  - 绿色：偏差 < 10%
  - 黄色：偏差 10% - 30%
  - 红色：偏差 > 30%

#### 3.3 其他信息展示
- 食物名称
- 营养成分（热量、蛋白质、碳水、脂肪、纤维、糖分）
- 模型返回的其他分析信息（description, insight 等）

---

## 🛠️ 技术实现要求

### 后端技术栈
- **框架：** FastAPI（与现有项目保持一致）
- **文件处理：** Python `zipfile` 库处理 ZIP 文件
- **图片处理：** 支持常见图片格式
- **模型调用：** 
  - 千问模型：使用现有的 `_analyze_with_qwen()` 函数
  - Gemini 模型：使用现有的 `_analyze_with_gemini()` 函数

### 前端技术栈
- **框架：** 使用现代前端框架（React/Vue/原生 HTML+JS）
- **UI 组件：** 表格组件（支持排序、筛选）
- **文件上传：** 支持 ZIP 文件和单张图片上传
- **数据可视化：** 表格展示，支持偏差百分比的颜色标识

### API 接口设计

#### 接口 1：批量测试（ZIP 上传）
```
POST /api/test/batch-upload
Content-Type: multipart/form-data

Request:
- file: ZIP 文件

Response:
{
  "success": true,
  "data": [
    {
      "imageName": "apple.jpg",
      "trueWeight": 50.0,
      "qwenResult": {
        "estimatedWeight": 48.5,
        "deviation": 3.0,  // 偏差百分比
        "items": [...],     // 完整的分析结果
        "description": "...",
        "insight": "..."
      },
      "geminiResult": {
        "estimatedWeight": 52.0,
        "deviation": 4.0,
        "items": [...],
        "description": "...",
        "insight": "..."
      }
    },
    ...
  ],
  "summary": {
    "totalImages": 10,
    "qwenAvgDeviation": 5.2,
    "geminiAvgDeviation": 6.8
  }
}
```

#### 接口 2：单张图片测试
```
POST /api/test/single-image
Content-Type: multipart/form-data

Request:
- image: 图片文件
- trueWeight: 真实重量（浮点数，单位：克）

Response:
{
  "success": true,
  "data": {
    "imageName": "uploaded_image.jpg",
    "trueWeight": 100.0,
    "qwenResult": {...},  // 同批量测试格式
    "geminiResult": {...}
  }
}
```

---

## 📁 文件结构要求

所有代码实现应在 `backend` 文件夹中：

```
backend/
├── main.py                    # 添加新的 API 端点
├── test_backend/              # 测试后台相关代码（新建）
│   ├── __init__.py
│   ├── batch_processor.py    # ZIP 文件处理和批量分析逻辑
│   ├── single_processor.py   # 单张图片分析逻辑
│   └── utils.py              # 工具函数（偏差计算等）
├── static/                    # 静态文件（新建）
│   └── test_backend/          # 测试后台前端文件
│       ├── index.html
│       ├── style.css
│       └── app.js
└── docs/
    └── 测试后台开发需求.md    # 本文档
```

---

## 🔍 实现细节说明

### 偏差计算
```python
def calculate_deviation(estimated_weight: float, true_weight: float) -> float:
    """
    计算偏差百分比
    返回: 偏差百分比（0-100之间的浮点数）
    """
    if true_weight == 0:
        return 0.0 if estimated_weight == 0 else 100.0
    return abs(estimated_weight - true_weight) / true_weight * 100
```

### 标签文件解析
- 逐行读取 `labels.txt`
- 使用正则表达式或字符串分割提取文件名和重量
- 处理可能的格式问题（多余空格、大小写等）
- 验证文件名是否存在于 ZIP 包中

### 错误处理
- ZIP 文件格式错误
- 缺少 `labels.txt` 文件
- 标签文件格式错误
- 图片文件无法读取
- 模型调用失败（单个失败不影响其他图片的处理）
- 文件大小限制（建议 ZIP < 50MB，单张图片 < 10MB）

---

## ✅ 验收标准

1. ✅ 能够成功上传 ZIP 文件并解析标签
2. ✅ 能够对每张图片调用两个模型进行分析
3. ✅ 能够正确计算偏差百分比
4. ✅ 能够以表格形式展示所有结果
5. ✅ 能够同时展示两种模型的对比结果
6. ✅ 单张图片测试功能正常工作
7. ✅ 前端界面美观、易用
8. ✅ 错误处理完善，有友好的错误提示

---

## 📝 注意事项

1. **复用现有代码：** 尽量复用 `main.py` 中已有的模型调用函数
2. **异步处理：** 批量测试时，可以考虑异步并发处理多张图片以提高效率
3. **进度反馈：** 批量处理时，建议提供进度反馈（WebSocket 或轮询）
4. **数据持久化：** 可选：将测试结果保存到数据库，方便后续查看历史记录
5. **性能优化：** 批量测试时注意控制并发数，避免 API 限流

---

## 🎨 UI/UX 建议

- 上传区域：支持拖拽上传
- 进度显示：批量处理时显示进度条
- 结果表格：支持按偏差百分比排序
- 图片预览：点击表格中的图片名可查看原图
- 导出功能：可选，支持导出结果为 CSV/Excel
